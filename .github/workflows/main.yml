name: Enhanced Siegel Strategy Monitor

on:
  schedule:
    # æ¯å‘¨ä¸€è‡³å‘¨äº”çš„ç¾å›½å¸‚åœºæ”¶ç›˜åè¿è¡Œ (UTCæ—¶é—´ 21:00ï¼Œå¯¹åº”ç¾ä¸œæ—¶é—´ 16:00)
    - cron: '0 21 * * 1-5'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

# æ·»åŠ å¯¹ issues çš„å†™å…¥æƒé™
permissions:
  contents: read
  issues: write

jobs:
  run-strategy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
      - name: Create data and charts directories
        run: |
          mkdir -p data
          mkdir -p charts
          
      - name: Verify data directory permissions
        run: |
          # ç¡®ä¿æ•°æ®ç›®å½•å­˜åœ¨å¹¶æœ‰å†™å…¥æƒé™
          ls -la data/
          touch data/test_file.txt
          rm data/test_file.txt
          echo "Data directory verified"
          
      - name: Run Enhanced Siegel Strategy
        env:
          FINNHUB_API_KEY: ${{ secrets.FINNHUB_API_KEY }}
        run: |
          # ä½¿ç”¨æ›´è¯¦ç»†çš„æ—¥å¿—çº§åˆ«è¿è¡Œ
          python run_strategy.py --no-email --force-download
          # æ£€æŸ¥æ˜¯å¦ç”Ÿæˆäº†å¿…è¦çš„æ–‡ä»¶
          echo "æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶:"
          ls -la data/
          ls -la charts/
          
      - name: Debug log if failed
        if: failure()
        run: |
          echo "ç­–ç•¥è¿è¡Œå¤±è´¥ï¼Œæ˜¾ç¤ºæ—¥å¿—:"
          if [ -f enhanced_siegel.log ]; then
            cat enhanced_siegel.log
          else
            echo "æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨"
          fi
          # æ˜¾ç¤ºç¯å¢ƒä¿¡æ¯
          echo "Pythonç‰ˆæœ¬:"
          python --version
          echo "Pandasç‰ˆæœ¬:"
          pip show pandas
          
      - name: Upload charts as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: strategy-charts
          path: |
            charts/*.png
            charts/*.html
            
      - name: Read strategy report
        id: report
        run: |
          REPORT=$(tail -n 50 enhanced_siegel.log | grep -A 50 "ä¿¡å·æŠ¥å‘Š" || echo "No report found")
          echo "report<<EOF" >> $GITHUB_ENV
          echo "$REPORT" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          
          # æå–ä¿¡å·ç±»å‹å’Œä»“ä½
          SIGNAL_TYPE=$(echo "$REPORT" | grep "ä¿¡å·ç±»å‹" | cut -d':' -f2 || echo "æœªçŸ¥ä¿¡å·")
          POSITION=$(echo "$REPORT" | grep "å»ºè®®ä»“ä½" | cut -d':' -f2 || echo "æœªçŸ¥ä»“ä½")
          echo "signal_type=$SIGNAL_TYPE" >> $GITHUB_OUTPUT
          echo "position=$POSITION" >> $GITHUB_OUTPUT
          
          # è®¾ç½®EMAIL_RECIPIENTç¯å¢ƒå˜é‡(å¦‚æœSecretå·²é…ç½®)
          if [ -n "${{ secrets.EMAIL_RECIPIENT }}" ]; then
            echo "EMAIL_RECIPIENT=${{ secrets.EMAIL_RECIPIENT }}" >> $GITHUB_ENV
          else
            echo "æœªé…ç½®EMAIL_RECIPIENTï¼Œå°†ä¸å‘é€é‚®ä»¶é€šçŸ¥"
          fi
      
      # ä½¿ç”¨ GitHub Issues ä½œä¸ºé€šçŸ¥æ–¹å¼ï¼Œä¸éœ€è¦é‚®ç®±é…ç½®
      - name: Create GitHub Issue with Strategy Report
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const date = new Date().toISOString().split('T')[0];
            const signalType = '${{ steps.report.outputs.signal_type }}' || 'æœªçŸ¥ä¿¡å·';
            const position = '${{ steps.report.outputs.position }}' || 'æœªçŸ¥ä»“ä½';
            
            const title = `ã€å¢å¼ºè¥¿æ ¼å°”ç­–ç•¥ã€‘ä¿¡å·æ›´æ–° - ${signalType} ${position} (${date})`;
            const body = `## å¢å¼ºè¥¿æ ¼å°”ç­–ç•¥ç›‘æ§æŠ¥å‘Š
            
            ${process.env.report || 'æ— æŠ¥å‘Šå†…å®¹'}
            
            ---
            
            *æ­¤æŠ¥å‘Šç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆäº ${new Date().toISOString()}*
            *æŸ¥çœ‹ [ç­–ç•¥å›¾è¡¨](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) è·å–æ›´å¤šè¯¦æƒ…*`;
            
            // åˆ›å»º Issue
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['strategy-signal', 'automated-report']
            });

      # æ£€æŸ¥SMTPé…ç½®çš„å®Œæ•´æ€§
      - name: Check SMTP configuration
        if: ${{ env.EMAIL_RECIPIENT != '' }}
        run: |
          # æ£€æŸ¥SMTPé…ç½®æ˜¯å¦å®Œæ•´
          if [ -z "${{ secrets.SMTP_SERVER }}" ]; then
            echo "âš ï¸ è­¦å‘Š: SMTP_SERVER æœªé…ç½®ï¼Œå°†ä½¿ç”¨é»˜è®¤å€¼ smtp.gmail.com"
            echo "SMTP_SERVER=smtp.gmail.com" >> $GITHUB_ENV
          fi
          
          if [ -z "${{ secrets.SMTP_PORT }}" ]; then
            echo "âš ï¸ è­¦å‘Š: SMTP_PORT æœªé…ç½®ï¼Œå°†ä½¿ç”¨é»˜è®¤å€¼ 465"
            echo "SMTP_PORT=465" >> $GITHUB_ENV
          fi
          
          if [ -z "${{ secrets.EMAIL_SENDER }}" ]; then
            echo "âš ï¸ è­¦å‘Š: EMAIL_SENDER æœªé…ç½®ï¼Œå°†ä½¿ç”¨é»˜è®¤å€¼ github-actions@github.com"
            echo "EMAIL_SENDER=github-actions@github.com" >> $GITHUB_ENV
          fi
          
          if [ -z "${{ secrets.EMAIL_PASSWORD }}" ]; then
            echo "âš ï¸ é”™è¯¯: EMAIL_PASSWORD æœªé…ç½®ï¼Œé‚®ä»¶å‘é€å¯èƒ½ä¼šå¤±è´¥"
          fi
          
          echo "ğŸ“§ é‚®ä»¶é…ç½®æ£€æŸ¥å®Œæˆ"
      
      # ä»…å½“è®¾ç½®äº† EMAIL_RECIPIENT æ—¶æ‰å‘é€é‚®ä»¶ 
      - name: Send notification email
        if: ${{ env.EMAIL_RECIPIENT != '' }}
        continue-on-error: true  # å³ä½¿é‚®ä»¶å‘é€å¤±è´¥ï¼Œä¹Ÿç»§ç»­æ‰§è¡Œåç»­æ­¥éª¤
        env:
          EMAIL_RECIPIENT: ${{ secrets.EMAIL_RECIPIENT }}
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.EMAIL_SENDER }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: ã€å¢å¼ºè¥¿æ ¼å°”ç­–ç•¥ã€‘ä¿¡å·æ›´æ–° - ${{ steps.report.outputs.signal_type }} ${{ steps.report.outputs.position }}
          to: ${{ secrets.EMAIL_RECIPIENT }}
          from: GitHub Actions <${{ secrets.EMAIL_SENDER }}>
          body: |
            # å¢å¼ºè¥¿æ ¼å°”ç­–ç•¥ç›‘æ§æŠ¥å‘Š
            
            ${{ env.report }}
            
            ---
            
            æ­¤é‚®ä»¶ç”± GitHub Actions è‡ªåŠ¨å‘é€ï¼Œè¯·å‹¿å›å¤ã€‚
            æŸ¥çœ‹ GitHub ä»“åº“è·å–æ›´å¤šè¯¦æƒ…ï¼šhttps://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          html_body: |
            <h1>å¢å¼ºè¥¿æ ¼å°”ç­–ç•¥ç›‘æ§æŠ¥å‘Š</h1>
            <pre>
            ${{ env.report }}
            </pre>
            <hr>
            <p>æ­¤é‚®ä»¶ç”± GitHub Actions è‡ªåŠ¨å‘é€ï¼Œè¯·å‹¿å›å¤ã€‚</p>
            <p><a href="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}">æŸ¥çœ‹ GitHub ä»“åº“è·å–æ›´å¤šè¯¦æƒ…</a></p>

      # æ·»åŠ é‚®ä»¶å‘é€åçš„æ—¥å¿—è¾“å‡º
      - name: Log email sending status
        if: ${{ env.EMAIL_RECIPIENT != '' }}
        run: |
          echo "é‚®ä»¶å‘é€å°è¯•å®Œæˆ"
          echo "å¦‚æœæ‚¨æ²¡æœ‰æ”¶åˆ°é‚®ä»¶ï¼Œè¯·æ£€æŸ¥ä»¥ä¸‹å‡ ç‚¹ï¼š"
          echo "1. SMTP_SERVER å’Œ SMTP_PORT é…ç½®æ˜¯å¦æ­£ç¡®"
          echo "2. å¦‚æœä½¿ç”¨Gmailï¼Œç¡®ä¿EMAIL_PASSWORDæ˜¯åº”ç”¨ä¸“ç”¨å¯†ç "
          echo "3. æ£€æŸ¥é‚®ä»¶æ¥æ”¶æ–¹çš„åƒåœ¾é‚®ä»¶æ–‡ä»¶å¤¹"
